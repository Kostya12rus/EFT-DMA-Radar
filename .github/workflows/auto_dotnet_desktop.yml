name: Deploy to GitHub Releases

on:
  push:
    branches:
      - master
    paths:
      - 'Maps/**'
      - 'Resources/**'
      - 'src/**'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Deploy
    if: github.repository_owner == 'Kostya12rus'
    runs-on: windows-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Generate daily auto-increment version
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.VPK_GITHUB_TOKEN }}
        run: |
          $year = (Get-Date).Year
          $month = (Get-Date).Month
          $day = (Get-Date).Day
          $md = "$month$day"
          $basePrefix = "$year.$md"
          Write-Host "Base prefix: $basePrefix"

          $releasesJson = gh release list --limit 100 --json tagName
          $releases = @()
          if ($releasesJson -and $releasesJson.Trim() -ne "") {
            $releases = $releasesJson | ConvertFrom-Json
          }

          $nums = @()

          foreach ($rel in $releases) {
            $tag = $rel.tagName
            if (-not $tag) { continue }

            if ($tag -match "^v$year\.$md\.(\d+)$") {
              $patch = [int]$Matches[1]
              $nums += $patch
            }
          }

          if ($nums.Count -eq 0) {
            $patch = 1
          } else {
            $patch = ($nums | Measure-Object -Maximum).Maximum + 1
          }

          $version = "$basePrefix.$patch"

          Write-Host "Resolved PACK_VERSION: $version"
          "PACK_VERSION=$version" >> $env:GITHUB_ENV

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.0.x
            10.0.x

      - name: Install Velopack CLI
        run: |
          dotnet tool install -g vpk

      - name: Dotnet Publish
        run: |
          dotnet publish src/Lone-EFT-DMA-Radar.csproj `
            -c Release `
            -r win-x64 `
            --no-self-contained `
            /p:PublishSingleFile=true `
            /p:DebugType=none `
            /p:Version=${{ env.PACK_VERSION }} `
            -o out

      - name: Download previous release data
        env:
          VPK_GITHUB_TOKEN: ${{ secrets.VPK_GITHUB_TOKEN }}
        run: |
          vpk download github `
            --repoUrl "https://github.com/${{ github.repository }}" `
            --token "$env:VPK_GITHUB_TOKEN"

      - name: Pack with Velopack
        run: |
          vpk pack `
            --packId github.Kostya12rus.eft `
            --packVersion "${{ env.PACK_VERSION }}" `
            --packDir "out" `
            --mainExe "Moulman-EFT-DMA-Radar.exe" `
            --packTitle "Moulman's EFT DMA Radar" `
            --icon "Resources/lone-icon.ico"

      - name: Upload to GitHub Releases
        env:
          VPK_GITHUB_TOKEN: ${{ secrets.VPK_GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $version = $env:PACK_VERSION
          Write-Host "Uploading release for version: $version"

          vpk upload github `
            --repoUrl "https://github.com/${{ github.repository }}" `
            --publish `
            --releaseName "EFT $version" `
            --tag "v$version" `
            --targetCommitish "${{ github.sha }}" `
            --token "$env:VPK_GITHUB_TOKEN"
