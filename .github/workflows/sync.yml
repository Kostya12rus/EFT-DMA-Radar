name: Sync from moulmandev

on:
  schedule:
    - cron: "15/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout my fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.VPK_GITHUB_TOKEN }}

      - name: Configure git identity
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          echo "Configured git identity as:"
          git config user.name
          git config user.email

      - name: Add upstream (moulmandev)
        run: |
          git remote add upstream https://github.com/moulmandev/EFT-DMA-Radar.git
          git fetch upstream
          echo "--- Remotes ---"
          git remote -v
          echo "--- Upstream/master last 5 commits ---"
          git log upstream/master --oneline -5

      - name: Check if there are new commits from upstream
        id: check_upstream
        run: |
          echo "--- Commits difference (master..upstream/master) ---"
          git log master..upstream/master --oneline || true

          COMMITS=$(git rev-list master..upstream/master --count)
          echo "COMMITS from upstream: $COMMITS"

          if [ "$COMMITS" -eq 0 ]; then
            echo "No new commits from upstream, nothing to sync."
            echo "sync_needed=false" >> $GITHUB_OUTPUT
          else
            echo "New commits found from upstream, sync needed."
            echo "sync_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream/master into my master
        if: steps.check_upstream.outputs.sync_needed == 'true'
        run: |
          git checkout master
          echo "--- Before merge (master last 5 commits) ---"
          git log --oneline -5
          echo "--- Start merge ---"
          git merge upstream/master --no-edit
          echo "--- After merge (master last 5 commits) ---"
          git log --oneline -5

      - name: Show git status after merge
        if: steps.check_upstream.outputs.sync_needed == 'true'
        run: |
          echo "--- GIT STATUS ---"
          git status
          echo "--- DIFF STAT (origin/master..master) ---"
          git diff --stat origin/master..master || true

      - name: Push back to my fork
        if: steps.check_upstream.outputs.sync_needed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.VPK_GITHUB_TOKEN }}
        run: |
          echo "--- Push to origin master ---"
          git push origin master
